#!/usr/bin/env python3
"""
Script para adicionar funcionalidades de sincronizaÃ§Ã£o Ã  GUI
Execute este script para atualizar automaticamente a gui.py
"""

import re
from pathlib import Path

def add_sync_import():
    """Adiciona import do mÃ³dulo sync"""
    gui_path = Path("src/gui.py")
    content = gui_path.read_text(encoding='utf-8')

    # Verificar se jÃ¡ tem o import
    if "from sync import SyncManager" in content:
        print("âœ“ Import de sync jÃ¡ existe")
        return

    # Adicionar apÃ³s os outros imports internos
    content = content.replace(
        "from alerts import AlertsManager",
        "from alerts import AlertsManager\nfrom sync import SyncManager"
    )

    gui_path.write_text(content, encoding='utf-8')
    print("âœ“ Import de sync adicionado")


def add_sync_initialization():
    """Adiciona inicializaÃ§Ã£o do SyncManager"""
    gui_path = Path("src/gui.py")
    content = gui_path.read_text(encoding='utf-8')

    # Verificar se jÃ¡ tem
    if "self.sync_manager = SyncManager" in content:
        print("âœ“ InicializaÃ§Ã£o de sync jÃ¡ existe")
        return

    # Adicionar apÃ³s self.alerts_manager
    content = content.replace(
        "self.alerts_manager = AlertsManager(self.db)",
        "self.alerts_manager = AlertsManager(self.db)\n        self.sync_manager = SyncManager(self.db, self.scraper)"
    )

    gui_path.write_text(content, encoding='utf-8')
    print("âœ“ InicializaÃ§Ã£o de sync adicionada")


def add_sync_tab():
    """Adiciona aba de sincronizaÃ§Ã£o"""
    gui_path = Path("src/gui.py")
    content = gui_path.read_text(encoding='utf-8')

    # Verificar se jÃ¡ tem
    if "create_sync_tab" in content:
        print("âœ“ Aba de sincronizaÃ§Ã£o jÃ¡ existe")
        return

    # Adicionar chamada de criaÃ§Ã£o da aba
    content = content.replace(
        "self.create_import_tab()",
        "self.create_import_tab()\n        self.create_sync_tab()"
    )

    # Adicionar mÃ©todo create_sync_tab antes de create_status_bar
    sync_tab_code = '''
    def create_sync_tab(self):
        """Cria a aba de sincronizaÃ§Ã£o"""
        sync_frame = ttk.Frame(self.notebook)
        self.notebook.add(sync_frame, text="SincronizaÃ§Ã£o")

        # TÃ­tulo
        titulo = ttk.Label(
            sync_frame,
            text="SincronizaÃ§Ã£o AutomÃ¡tica de Dados",
            font=('Arial', 14, 'bold')
        )
        titulo.pack(pady=20)

        # Frame de status
        status_frame = ttk.LabelFrame(sync_frame, text="Estado da SincronizaÃ§Ã£o", padding=20)
        status_frame.pack(fill=tk.X, padx=40, pady=10)

        self.sync_status_labels = {}

        info_items = [
            ('auto_sync', 'SincronizaÃ§Ã£o AutomÃ¡tica:', 0),
            ('ultima_sync', 'Ãšltima SincronizaÃ§Ã£o:', 1),
            ('proxima_sync', 'PrÃ³xima SincronizaÃ§Ã£o:', 2),
            ('total_contratos', 'Total de Contratos:', 3),
            ('contratos_24h', 'Novos (24h):', 4),
        ]

        for key, label, row in info_items:
            ttk.Label(status_frame, text=label, font=('Arial', 10, 'bold')).grid(
                row=row, column=0, sticky=tk.W, padx=5, pady=5
            )
            value_label = ttk.Label(status_frame, text="...", font=('Arial', 10))
            value_label.grid(row=row, column=1, sticky=tk.W, padx=5, pady=5)
            self.sync_status_labels[key] = value_label

        # Frame de configuraÃ§Ã£o
        config_frame = ttk.LabelFrame(sync_frame, text="ConfiguraÃ§Ã£o", padding=20)
        config_frame.pack(fill=tk.X, padx=40, pady=10)

        # Auto sync checkbox
        self.auto_sync_var = tk.BooleanVar()
        ttk.Checkbutton(
            config_frame,
            text="Ativar sincronizaÃ§Ã£o automÃ¡tica",
            variable=self.auto_sync_var,
            command=self.toggle_auto_sync
        ).pack(anchor=tk.W, pady=5)

        # Intervalo
        interval_frame = ttk.Frame(config_frame)
        interval_frame.pack(anchor=tk.W, pady=10)

        ttk.Label(interval_frame, text="Intervalo:").pack(side=tk.LEFT, padx=5)
        self.sync_interval_var = tk.IntVar(value=24)
        ttk.Spinbox(
            interval_frame,
            from_=1,
            to=168,
            textvariable=self.sync_interval_var,
            width=10
        ).pack(side=tk.LEFT, padx=5)
        ttk.Label(interval_frame, text="horas").pack(side=tk.LEFT, padx=5)

        ttk.Button(
            config_frame,
            text="Guardar ConfiguraÃ§Ã£o",
            command=self.save_sync_config
        ).pack(anchor=tk.W, pady=10)

        # Frame de aÃ§Ãµes
        action_frame = ttk.LabelFrame(sync_frame, text="AÃ§Ãµes", padding=20)
        action_frame.pack(fill=tk.X, padx=40, pady=10)

        ttk.Button(
            action_frame,
            text="Sincronizar Agora",
            command=self.sync_now
        ).pack(side=tk.LEFT, padx=5, pady=5)

        ttk.Button(
            action_frame,
            text="Otimizar Base de Dados",
            command=self.optimize_database
        ).pack(side=tk.LEFT, padx=5, pady=5)

        ttk.Button(
            action_frame,
            text="Ver Estimativas de Tamanho",
            command=self.show_size_estimates
        ).pack(side=tk.LEFT, padx=5, pady=5)

        ttk.Button(
            action_frame,
            text="Atualizar Estado",
            command=self.update_sync_status
        ).pack(side=tk.LEFT, padx=5, pady=5)

        # Carregar estado inicial
        self.update_sync_status()

    def update_sync_status(self):
        """Atualiza informaÃ§Ãµes de estado da sincronizaÃ§Ã£o"""
        try:
            status = self.sync_manager.get_sync_status()

            self.sync_status_labels['auto_sync'].config(
                text="Ativo" if status['auto_sync_ativo'] else "Inativo"
            )

            ultima = status['ultima_sincronizacao']
            self.sync_status_labels['ultima_sync'].config(
                text=ultima[:19] if ultima else "Nunca"
            )

            proxima = status['proxima_sincronizacao']
            self.sync_status_labels['proxima_sync'].config(
                text=proxima[:19] if proxima else "N/A"
            )

            self.sync_status_labels['total_contratos'].config(
                text=f"{status['total_contratos_bd']:,}"
            )

            self.sync_status_labels['contratos_24h'].config(
                text=f"{status['contratos_ultimas_24h']:,}"
            )

            # Atualizar variÃ¡veis
            config = self.sync_manager.config
            self.auto_sync_var.set(config.get('auto_sync', False))
            self.sync_interval_var.set(config.get('sync_interval_hours', 24))

        except Exception as e:
            logger.error(f"Erro ao atualizar status de sync: {e}")

    def toggle_auto_sync(self):
        """Ativa/desativa sincronizaÃ§Ã£o automÃ¡tica"""
        auto_sync = self.auto_sync_var.get()
        self.sync_manager.configure_sync(
            auto_sync=auto_sync,
            interval_hours=self.sync_interval_var.get()
        )
        self.update_sync_status()
        messagebox.showinfo(
            "SincronizaÃ§Ã£o",
            f"SincronizaÃ§Ã£o automÃ¡tica {'ativada' if auto_sync else 'desativada'}"
        )

    def save_sync_config(self):
        """Guarda configuraÃ§Ã£o de sincronizaÃ§Ã£o"""
        try:
            self.sync_manager.configure_sync(
                auto_sync=self.auto_sync_var.get(),
                interval_hours=self.sync_interval_var.get(),
                incremental=True
            )
            messagebox.showinfo("Sucesso", "ConfiguraÃ§Ã£o guardada!")
            self.update_sync_status()
        except Exception as e:
            messagebox.showerror("Erro", f"Erro ao guardar configuraÃ§Ã£o: {e}")

    def sync_now(self):
        """Executa sincronizaÃ§Ã£o agora"""
        resposta = messagebox.askyesno(
            "Sincronizar",
            "Executar sincronizaÃ§Ã£o agora?\\n\\n"
            "Isto pode demorar alguns minutos se houver muitos dados novos."
        )

        if not resposta:
            return

        try:
            self.update_status("A sincronizar...")

            # Executar em thread para nÃ£o bloquear UI
            import threading

            def sync_thread():
                stats = self.sync_manager.sync_now()

                # Atualizar UI na thread principal
                self.root.after(0, lambda: self._sync_completed(stats))

            thread = threading.Thread(target=sync_thread, daemon=True)
            thread.start()

        except Exception as e:
            logger.error(f"Erro na sincronizaÃ§Ã£o: {e}")
            messagebox.showerror("Erro", f"Erro na sincronizaÃ§Ã£o: {e}")

    def _sync_completed(self, stats):
        """Callback quando sincronizaÃ§Ã£o completa"""
        if stats.get('sucesso'):
            messagebox.showinfo(
                "SincronizaÃ§Ã£o Completa",
                f"Contratos novos: {stats.get('contratos_novos', 0)}\\n"
                f"Alertas gerados: {stats.get('alertas_gerados', 0)}"
            )
            self.update_sync_status()
            self.atualizar_dashboard()
        else:
            erros = "\\n".join(stats.get('erros', []))
            messagebox.showerror("Erro", f"SincronizaÃ§Ã£o falhou:\\n{erros}")

        self.update_status("Pronto")

    def optimize_database(self):
        """Otimiza a base de dados"""
        resposta = messagebox.askyesno(
            "Otimizar",
            "Otimizar base de dados?\\n\\n"
            "Isto irÃ¡:\\n"
            "â€¢ Compactar dados (VACUUM)\\n"
            "â€¢ Atualizar estatÃ­sticas\\n"
            "â€¢ Reindexar tabelas\\n\\n"
            "Pode demorar alguns minutos com bases de dados grandes."
        )

        if not resposta:
            return

        try:
            self.update_status("A otimizar base de dados...")

            import threading

            def optimize_thread():
                stats = self.sync_manager.optimize_database()
                self.root.after(0, lambda: self._optimize_completed(stats))

            thread = threading.Thread(target=optimize_thread, daemon=True)
            thread.start()

        except Exception as e:
            logger.error(f"Erro na otimizaÃ§Ã£o: {e}")
            messagebox.showerror("Erro", f"Erro na otimizaÃ§Ã£o: {e}")

    def _optimize_completed(self, stats):
        """Callback quando otimizaÃ§Ã£o completa"""
        reducao = self.sync_manager._format_bytes(stats['reducao_bytes'])
        percentagem = stats['reducao_percentagem']

        messagebox.showinfo(
            "OtimizaÃ§Ã£o Completa",
            f"Base de dados otimizada!\\n\\n"
            f"EspaÃ§o recuperado: {reducao}\\n"
            f"ReduÃ§Ã£o: {percentagem:.1f}%"
        )

        self.update_status("Pronto")

    def show_size_estimates(self):
        """Mostra estimativas de tamanho"""
        try:
            stats = self.db.obter_estatisticas()
            total_contratos = stats['total_contratos']

            # Estimativas para diferentes cenÃ¡rios
            estimativas = self.sync_manager.estimate_database_size(total_contratos)

            texto = f"""
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘     ESTIMATIVAS DE TAMANHO DA BASE DE DADOS                    â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ATUAL ({total_contratos:,} contratos):
  â€¢ Sem otimizar: {estimativas['tamanho_sem_otimizar_formatado']}
  â€¢ Otimizado: {estimativas['tamanho_otimizado_formatado']}
  â€¢ Bytes por contrato: ~{estimativas['bytes_por_contrato']} bytes

PROJEÃ‡Ã•ES:
  â€¢ 10 mil contratos: {estimativas['estimativas_cenarios']['10_mil_contratos']}
  â€¢ 100 mil contratos: {estimativas['estimativas_cenarios']['100_mil_contratos']}
  â€¢ 500 mil contratos: {estimativas['estimativas_cenarios']['500_mil_contratos']}
  â€¢ 1 milhÃ£o contratos: {estimativas['estimativas_cenarios']['1_milhao_contratos']}

ğŸ’¡ DICAS:
  â€¢ Execute "Otimizar BD" regularmente (reduz ~30%)
  â€¢ Exporte e remova contratos muito antigos
  â€¢ Mantenha apenas dados relevantes

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            """

            # Mostrar em janela
            window = tk.Toplevel(self.root)
            window.title("Estimativas de Tamanho")
            window.geometry("700x500")

            text_widget = scrolledtext.ScrolledText(window, wrap=tk.WORD, font=('Courier', 10))
            text_widget.pack(fill=tk.BOTH, expand=True, padx=10, pady=10)
            text_widget.insert(tk.END, texto)
            text_widget.config(state=tk.DISABLED)

            ttk.Button(window, text="Fechar", command=window.destroy).pack(pady=10)

        except Exception as e:
            logger.error(f"Erro ao calcular estimativas: {e}")
            messagebox.showerror("Erro", f"Erro: {e}")

'''

    # Inserir antes de create_status_bar
    content = content.replace(
        "    def create_status_bar(self):",
        sync_tab_code + "\n    def create_status_bar(self):"
    )

    gui_path.write_text(content, encoding='utf-8')
    print("âœ“ Aba de sincronizaÃ§Ã£o adicionada")


def main():
    print("""
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘     ADICIONAR FUNCIONALIDADES DE SINCRONIZAÃ‡ÃƒO                 â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    """)

    try:
        add_sync_import()
        add_sync_initialization()
        add_sync_tab()

        print("\nâœ“ Todas as modificaÃ§Ãµes aplicadas com sucesso!")
        print("\nA GUI agora inclui:")
        print("  â€¢ Aba de SincronizaÃ§Ã£o")
        print("  â€¢ SincronizaÃ§Ã£o automÃ¡tica configurÃ¡vel")
        print("  â€¢ OtimizaÃ§Ã£o de base de dados")
        print("  â€¢ Estimativas de tamanho")

    except Exception as e:
        print(f"\nâœ— Erro: {e}")
        import traceback
        traceback.print_exc()


if __name__ == "__main__":
    main()
